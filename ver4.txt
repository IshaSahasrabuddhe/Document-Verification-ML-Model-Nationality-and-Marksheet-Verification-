import cv2
import easyocr
import numpy as np
import difflib
from skimage.metrics import structural_similarity as ssim
import os
import re

# ============================================================
#                    DOCUMENT KEYWORDS
# ============================================================
SSC_KEYWORDS = [
    "à¤®à¤¹à¤¾à¤°à¤¾à¤·à¥à¤Ÿà¥à¤° à¤°à¤¾à¤œà¥à¤¯ à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤µ à¤‰à¤šà¥à¤š à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤¶à¤¿à¤•à¥à¤·à¤£ à¤®à¤‚à¤¡à¤³",
    "Maharashtra State Board Of Secondary and Higher Secondary Education, Pune",
    "à¤ªà¥à¤£à¥‡ à¤µà¤¿à¤­à¤¾à¤—à¥€à¤¯ à¤®à¤‚à¤¡à¤³", "PUNE DIVISIONAL BOARD",
    "à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤¶à¤¾à¤²à¤¾à¤¨à¥à¤¤ à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤° à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤—à¥à¤£à¤ªà¤¤à¥à¤°à¤•",
    "SECONDARY SCHOOL CERTIFICATE EXAMINATION - STATEMENT OF MARKS",
    "à¤†à¤¸à¤¨ à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "SEAT NO.",
    "à¤œà¤¿à¤²à¥à¤¹à¤¾ à¤µ à¤¶à¤¾à¤³à¤¾ à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "DIST. & SCHOOL NO.",
    "à¤ªà¤°à¥€à¤•à¥à¤·à¥‡à¤šà¥‡ à¤µà¤°à¥à¤·", "YEAR OF EXAM",
    "à¤•à¥‡à¤‚à¤¦à¥à¤° à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "CENTRE NO.",
    "à¤—à¥à¤£à¤ªà¤¤à¥à¤°à¤¿à¤•à¥‡à¤šà¤¾ à¤…à¤¨à¥à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "SR.NO. OF STATEMENT",
    "à¤‰à¤®à¥‡à¤¦à¤µà¤¾à¤°à¤¾à¤šà¥‡ à¤¸à¤‚à¤ªà¥‚à¤°à¥à¤£ à¤¨à¤¾à¤µ", "CANDIDATE'S FULL NAME",
    "à¤‰à¤®à¥‡à¤¦à¤µà¤¾à¤°à¤¾à¤šà¥à¤¯à¤¾ à¤†à¤ˆà¤šà¥‡ à¤¨à¤¾à¤µ", "CANDIDATE'S MOTHER'S NAME",
    "à¤µà¤¿à¤·à¤¯à¤¾à¤šà¤¾ à¤¸à¤¾à¤‚à¤•à¥‡à¤¤à¤¿à¤• à¤•à¥à¤°à¤®à¤¾à¤‚à¤• à¤µ à¤µà¤¿à¤·à¤¯à¤¾à¤šà¥‡ à¤¨à¤¾à¤µ", "Subject Code No. and Subject Name",
    "à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤—à¥à¤£ à¤•à¤¿à¤‚à¤µà¤¾ à¤¶à¥à¤°à¥‡à¤£à¥€", "Marks or Grade Obtained",
    "à¤…à¤•à¥à¤·à¤°à¤¾à¤¤", "In Words", "Percentage", "à¤Ÿà¤•à¥à¤•à¥‡à¤µà¤¾à¤°à¥€",
    "à¤¨à¤¿à¤•à¤¾à¤²", "Result", "Divisional Secretary"
]

HSC_KEYWORDS = [
    "à¤®à¤¹à¤¾à¤°à¤¾à¤·à¥à¤Ÿà¥à¤° à¤°à¤¾à¤œà¥à¤¯ à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤µ à¤‰à¤šà¥à¤š à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤¶à¤¿à¤•à¥à¤·à¤£ à¤®à¤‚à¤¡à¤³",
    "Maharashtra State Board Of Secondary and Higher Secondary Education",
    "à¤ªà¥à¤£à¥‡ à¤µà¤¿à¤­à¤¾à¤—à¥€à¤¯ à¤®à¤‚à¤¡à¤³", "PUNE DIVISIONAL BOARD",
    "à¤‰à¤šà¥à¤š à¤®à¤¾à¤§à¥à¤¯à¤®à¤¿à¤• à¤ªà¥à¤°à¤®à¤¾à¤£à¤ªà¤¤à¥à¤° à¤ªà¤°à¥€à¤•à¥à¤·à¤¾ à¤—à¥à¤£à¤ªà¤¤à¥à¤°à¤•", "HIGHER SECONDARY CERTIFICATE EXAMINATION",
    "à¤¶à¤¾à¤–à¤¾", "STREAM", "SCIENCE",
    "à¤†à¤¸à¤¨ à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "SEAT NO.", "à¤•à¥‡à¤‚à¤¦à¥à¤° à¤•à¥à¤°à¤®à¤¾à¤‚à¤•", "CENTRE NO",
    "à¤ªà¤°à¥€à¤•à¥à¤·à¥‡à¤šà¤¾ à¤®à¤¹à¤¿à¤¨à¤¾ à¤µà¤°à¥à¤·à¤¾à¤¨à¥", "MONTH & YEAR OF EXAM",
    "à¤‰à¤®à¥‡à¤¦à¤µà¤¾à¤°à¤¾à¤šà¥‡ à¤¸à¤‚à¤ªà¥‚à¤°à¥à¤£ à¤¨à¤¾à¤µ", "CANDIDATE'S FULL NAME",
    "à¤‰à¤®à¥‡à¤¦à¤µà¤¾à¤°à¤¾à¤šà¥à¤¯à¤¾ à¤†à¤ˆà¤šà¥‡ à¤¨à¤¾à¤µ", "CANDIDATE'S MOTHER'S NAME",
    "à¤µà¤¿à¤·à¤¯à¤¾à¤šà¤¾ à¤¸à¤¾à¤‚à¤•à¥‡à¤¤à¤¿à¤• à¤•à¥à¤°à¤®à¤¾à¤‚à¤• à¤µ à¤µà¤¿à¤·à¤¯à¤¾à¤šà¥‡ à¤¨à¤¾à¤µ", "Subject Code No. and Subject Name",
    "à¤ªà¥à¤°à¤¾à¤ªà¥à¤¤ à¤—à¥à¤£ à¤•à¤¿à¤¯à¤¾ à¤¶à¥à¤°à¥‡à¤·à¥à¤£à¥€", "Marks or Grade Obtained",
    "à¤…à¤•à¥à¤·à¤°à¤¾à¤¤", "In Words", "Percentage", "à¤Ÿà¤•à¥à¤•à¥‡à¤µà¤¾à¤°à¥€",
    "à¤¨à¤¿à¤•à¤¾à¤²", "Result", "Divisional Secretary"
]

CET_KEYWORDS = [
    "Government of Maharashtra",
    "State Common Entrance Test Cell, Maharashtra State, Mumbai",
    "MHT-CET (PCM Group) Score Card",
    "Application Number",
    "Candidate's Full Name",
    "Candidate's Father's/Husband's First Name",
    "Candidate's Mother's First Name",
    "Roll No",
    "Category",
    "CET Course",
    "MHT CET Percentile Score",
    "Physics", "Chemistry", "Mathematics",
    "Total Percentile Score PCM",
    "Date of the Result",
    "IP address of the Computer from which Score Card Downloaded",
    "Date and Time of Downloading the Score Card",
    "valid only for the academic year",
    "MHT CET Score is NOT the same as PERCENTAGE"
]

PASSPORT_KEYWORDS = [
    "REPUBLIC OF INDIA", "IND", "INDIAN", "Indian Passport",
    "Address", "Name of Father", "Name of Mother", "MAHARASHTRA",
    "Type", "Code", "Passport No.", "Surname", "Given Name(s)",
    "Nationality", "Date of Birth", "Place of Birth", "Sex",
    "Date of Issue", "Date of Expiry", "Place of Issue",
    "à¤­à¤¾à¤°à¤¤à¤¾à¤šà¥‡ à¤ªà¥à¤°à¤œà¤¾à¤¸à¤¤à¥à¤¤à¤¾à¤•", "à¤­à¤¾à¤°à¤¤à¥€à¤¯", "à¤ªà¤¤à¥à¤¤à¤¾", "à¤µà¤¡à¤¿à¤²à¤¾à¤‚à¤šà¥‡ à¤¨à¤¾à¤µ", "à¤®à¤¾à¤¤à¥‡à¤šà¥‡ à¤¨à¤¾à¤µ", "à¤²à¤¿à¤‚à¤—",
    "à¤œà¤¨à¥à¤® à¤¤à¤¾à¤°à¥€à¤–", "à¤œà¤¨à¥à¤® à¤¸à¥à¤¥à¤¾à¤¨", "à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°à¥€à¤¯à¤¤à¥à¤µ", "à¤œà¤¾à¤°à¥€ à¤¤à¤¾à¤°à¥€à¤–", "à¤•à¤¾à¤²à¤¬à¤¾à¤¹à¥à¤¯à¤¤à¤¾ à¤¤à¤¾à¤°à¥€à¤–", "à¤œà¤¾à¤°à¥€ à¤ à¤¿à¤•à¤¾à¤£"
]

DOMICILE_KEYWORDS = [
    "Tahsil Office", "Certificate of Age, Nationality and Domicile",
    "Issued by Authorities in the State of Maharashtra",
    "State of 'MAHARASHTRA'", "Nationality", "Domicile", "Certificate",
    "CITIZEN OF INDIA", "PARTICULARS OF PROOFS SUBMITTED", "Signature valid", "Seal"
]

# ============================================================
#               IMAGE PREPROCESSING + OCR
# ============================================================
def preprocess_image(image_path):
    img = cv2.imread(image_path)
    if img is None:
        raise ValueError(f"âŒ Could not read image at {image_path}")

    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    # Improve contrast and remove noise
    gray = cv2.convertScaleAbs(gray, alpha=1.3, beta=10)
    gray = cv2.fastNlMeansDenoising(gray, h=15)
    thresh = cv2.adaptiveThreshold(gray, 255,
                                   cv2.ADAPTIVE_THRESH_GAUSSIAN_C,
                                   cv2.THRESH_BINARY, 31, 2)
    return thresh


def extract_text(image_path):
    image = preprocess_image(image_path)
    reader = easyocr.Reader(['en', 'mr'])
    results = reader.readtext(image, detail=0, paragraph=True)
    text = " ".join(results)
    return re.sub(r'\s+', ' ', text).strip()

# ============================================================
#                 KEYWORD DETECTION (IMPROVED)
# ============================================================
def check_keywords(text, keywords):
    text_lower = text.lower()
    detected = []
    fuzzy_hits = []
    for kw in keywords:
        kw_low = kw.lower()
        if kw_low in text_lower:
            detected.append(kw)
        else:
            close = difflib.get_close_matches(kw_low, text_lower.split(), n=1, cutoff=0.7)
            if close:
                fuzzy_hits.append(kw)
    score = (len(detected) + 0.5 * len(fuzzy_hits)) / len(keywords)
    return detected, fuzzy_hits, round(score, 3)

# ============================================================
#           STRUCTURE MATCHING (HOMOGRAPHY + SSIM)
# ============================================================
def check_document_structure(image_path, reference_doc_path):
    """Compare edge & keypoint layout of input vs authentic reference."""
    try:
        input_img = cv2.imread(image_path)
        ref_img = cv2.imread(reference_doc_path)

        if input_img is None or ref_img is None:
            print("âŒ Could not load input/reference image")
            return 0.0, 0

        input_gray = cv2.cvtColor(input_img, cv2.COLOR_BGR2GRAY)
        ref_gray = cv2.cvtColor(ref_img, cv2.COLOR_BGR2GRAY)

        # Resize reference to match input size
        ref_gray = cv2.resize(ref_gray, (input_gray.shape[1], input_gray.shape[0]))

        # Structural similarity using edges
        edges_input = cv2.Canny(input_gray, 100, 200)
        edges_ref = cv2.Canny(ref_gray, 100, 200)
        structure_score, _ = ssim(edges_input, edges_ref, full=True)

        # Feature-based layout similarity
        orb = cv2.ORB_create()
        kp1, des1 = orb.detectAndCompute(input_gray, None)
        kp2, des2 = orb.detectAndCompute(ref_gray, None)

        if des1 is None or des2 is None:
            return 0.0, 0

        bf = cv2.BFMatcher(cv2.NORM_HAMMING, crossCheck=True)
        matches = bf.match(des1, des2)

        layout_match_ratio = len(matches) / max(len(kp1), 1)

        # Weighted structure + layout score
        overall_score = (structure_score * 0.6) + (layout_match_ratio * 0.4)

        return round(overall_score, 3), len(matches)

    except Exception as e:
        print("âš ï¸ Error in structure check:", e)
        return 0.0, 0

    

# ============================================================
#                     MAIN VERIFICATION
# ============================================================
def verify_document(image_path, doc_category, doc_type):
    ref_path = os.path.join('reference_documents', doc_category.lower(), f"{doc_type.lower()}_ref.jpg")

    if doc_type.lower() == 'ssc':
        keywords = SSC_KEYWORDS
    elif doc_type.lower() == 'hsc':
        keywords = HSC_KEYWORDS
    elif doc_type.lower() == 'cet':
        keywords = CET_KEYWORDS
    elif doc_type.lower() == 'passport':
        keywords = PASSPORT_KEYWORDS
    elif doc_type.lower() == 'domicile':
        keywords = DOMICILE_KEYWORDS
    else:
        keywords = []

    text = extract_text(image_path)
    detected, fuzzy, keyword_score = check_keywords(text, keywords)
    #structure_score = check_document_structure(image_path, ref_path)
    structure_score, match_count = check_document_structure(image_path, ref_path)


    # Determine Verification Level
    if keyword_score >= 0.3 and structure_score >= 0.5:
        level = "ðŸŸ¢ Verified"
    elif keyword_score >= 0 or structure_score >= 0:
        level = "ðŸŸ  Needs Manual Verification"
    else:
        level = "ðŸ”´ Rejected"

    return {
        "text": text,
        "detected_keywords": detected,
        "fuzzy_matches": fuzzy,
        "keyword_score": keyword_score,
        "structure_score": structure_score,
        "verification_level": level,
        "doc_type": doc_type,
        "doc_category": doc_category
    }

# ============================================================
# Example Run
# ============================================================
if __name__ == "__main__":
    result = verify_document("isha12thmrk.jpg", "marksheet", "hsc")
    for k, v in result.items():
        print(f"{k}: {v}")
